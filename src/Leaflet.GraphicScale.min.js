L.Control.GraphicScale=L.Control.extend({options:{position:"bottomleft",updateWhenIdle:false,minUnitWidth:30,maxUnitsWidth:240,fill:false,showSubunits:false,doubleLine:false,labelPlacement:"auto"},onAdd:function(a){this._map=a;this._possibleUnitsNum=[3,5,2,4];this._possibleUnitsNumLen=this._possibleUnitsNum.length;this._possibleDivisions=[1,0.5,0.25,0.2];this._possibleDivisionsLen=this._possibleDivisions.length;this._possibleDivisionsSub={1:{num:2,division:0.5},0.5:{num:5,division:0.1},0.25:{num:5,division:0.05},0.2:{num:2,division:0.1}};this._scaleInner=this._buildScale();this._scale=this._addScale(this._scaleInner);this._setStyle(this.options);a.on(this.options.updateWhenIdle?"moveend":"move",this._update,this);a.whenReady(this._update,this);return this._scale},onRemove:function(a){a.off(this.options.updateWhenIdle?"moveend":"move",this._update,this)},_addScale:function(a){var b=L.DomUtil.create("div");b.className="leaflet-control-graphicscale";b.appendChild(a);return b},_setStyle:function(a){var b=["leaflet-control-graphicscale-inner"];if(a.fill&&a.fill!=="nofill"){b.push("filled");b.push("filled-"+a.fill)}if(a.showSubunits){b.push("showsubunits")}if(a.doubleLine){b.push("double")}b.push("labelPlacement-"+a.labelPlacement);this._scaleInner.className=b.join(" ")},_buildScale:function(){var b=document.createElement("div");b.className="leaflet-control-graphicscale-inner";var g=L.DomUtil.create("div","subunits",b);var d=L.DomUtil.create("div","units",b);this._units=[];this._unitsLbls=[];this._subunits=[];for(var e=0;e<5;e++){var f=this._buildDivision(e%2===0);d.appendChild(f);this._units.push(f);var a=this._buildDivisionLbl();f.appendChild(a);this._unitsLbls.push(a);var c=this._buildDivision(e%2===1);g.appendChild(c);this._subunits.unshift(c)}this._zeroLbl=L.DomUtil.create("div","label zeroLabel");this._zeroLbl.innerHTML="0";this._units[0].appendChild(this._zeroLbl);this._subunitsLbl=L.DomUtil.create("div","label subunitsLabel");this._subunitsLbl.innerHTML="?";this._subunits[4].appendChild(this._subunitsLbl);return b},_buildDivision:function(d){var c=L.DomUtil.create("div","division");var b=L.DomUtil.create("div","line");c.appendChild(b);var a=L.DomUtil.create("div","line2");c.appendChild(a);if(d){b.appendChild(L.DomUtil.create("div","fill"))}if(!d){a.appendChild(L.DomUtil.create("div","fill"))}return c},_buildDivisionLbl:function(){var a=L.DomUtil.create("div","label divisionLabel");return a},_update:function(){var c=this._map.getBounds(),d=c.getCenter().lat,b=6378137*Math.PI*Math.cos(d*Math.PI/180),e=b*(c.getNorthEast().lng-c.getSouthWest().lng)/180,a=this._map.getSize();if(a.x>0){this._updateScale(e,this.options)}},_updateScale:function(b,a){var c=this._getBestScale(b,a.minUnitWidth,a.maxUnitsWidth);this._render(c)},_getBestScale:function(c,b,f){var e=this._getPossibleUnits(c,b,this._map.getSize().x);var a=this._getPossibleScales(e,f);a.sort(function(h,g){return g.score-h.score});var d=a[0];d.subunits=this._getSubunits(d);return d},_getSubunits:function(d){var b=this._possibleDivisionsSub[d.unit.unitDivision];var a={};a.subunitDivision=b.division;a.subunitMeters=b.division*(d.unit.unitMeters/d.unit.unitDivision);a.subunitPx=b.division*(d.unit.unitPx/d.unit.unitDivision);var c={subunit:a,numSubunits:b.num,total:b.num*a.subunitMeters};return c},_getPossibleScales:function(h,a){var k=[];var p=Number.POSITIVE_INFINITY;var n;for(var f=0;f<this._possibleUnitsNumLen;f++){var g=this._possibleUnitsNum[f];var l=(this._possibleUnitsNumLen-f)*0.5;for(var e=0;e<h.length;e++){var o=h[e];var m=o.unitPx*g;var d={unit:o,totalWidthPx:m,numUnits:g,score:0};var c=1-(a-m)/a;c*=3;var b=o.unitScore+l+c;if(o.unitDivision===0.25&&g===3||o.unitDivision===0.5&&g===3||o.unitDivision===0.25&&g===5){b-=2}d.score=b;if(m<a){k.push(d)}if(m<p){p=m;n=d}}}if(!k.length){k.push(n)}return k},_getPossibleUnits:function(k,l,g){var c=(Math.floor(k)+"").length;var b;var h=[];for(var e=c;e>0;e--){b=Math.pow(10,e);for(var d=0;d<this._possibleDivisionsLen;d++){var f=b*this._possibleDivisions[d];var a=g*(f/k);if(a<l){return h}h.push({unitMeters:f,unitPx:a,unitDivision:this._possibleDivisions[d],unitScore:this._possibleDivisionsLen-d})}}return h},_render:function(b){this._renderPart(b.unit.unitPx,b.unit.unitMeters,b.numUnits,this._units,this._unitsLbls);this._renderPart(b.subunits.subunit.subunitPx,b.subunits.subunit.subunitMeters,b.subunits.numSubunits,this._subunits);var a=this._getDisplayUnit(b.subunits.total);this._subunitsLbl.innerHTML=""+a.amount+a.unit},_renderPart:function(l,k,f,a,c){var g=this._getDisplayUnit(k);for(var e=0;e<this._units.length;e++){var h=a[e];if(e<f){h.style.width=l+"px";h.className="division"}else{h.style.width=0;h.className="division hidden"}if(!c){continue}var j=c[e];var b=["label","divisionLabel"];if(e<f){var d=(e+1)*g.amount;if(e===f-1){d+=g.unit;b.push("labelLast")}else{b.push("labelSub")}j.innerHTML=d}j.className=b.join(" ")}},_getDisplayUnit:function(a){var b=a<1000?"m":"km";return{unit:b,amount:b==="km"?a/1000:a}}});L.Map.mergeOptions({graphicScaleControl:false});L.Map.addInitHook(function(){if(this.options.graphicScaleControl){this.graphicScaleControl=new L.Control.GraphicScale;this.addControl(this.graphicScaleControl)}});L.control.graphicScale=function(a){return new L.Control.GraphicScale(a)};